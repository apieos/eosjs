<pre style='width: 100%; height: 100%; margin:0px; '>
    <h1> EOSJS Web Build Integration Test Suite </h1>
    <div><button onClick="runAllTests();">Run All Tests</button></div>
    <div><button onClick="transactWithConfig(event);">Transact with Configuration Parameter</button><label>Not Started</label></div>
    <div><button onClick="transactWithoutConfig(event);">Transact with Manually Configured TAPOS</button><label>Not Started</label></div>
    <div><button onClick="transactWithoutBroadcast(event);">Transact without Broadcasting</button><label>Not Started</label></div>

</pre>

<style>
    html, body {  
        max-width: 800px;
        margin: 0 auto;
    }
    h1 {
        color: darkblue;
    }
    div {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    button {
        margin: .5rem 1rem;
        padding: 1rem 2rem;
        border: 2px solid grey;
        border-radius: .5rem;
        font-size: .85rem;
    }
    label {
        font-size: 1.4rem;
    }
</style>

<script src='../../dist-web/eosjs-api.js'></script>
<script src='../../dist-web/eosjs-jsonrpc.js'></script>
<script src='../../dist-web/eosjs-jssig.js'></script>
<script>
    const privateKey = '5JuH9fCXmU3xbj8nRmhPZaVrxxXrdPaRmZLW1cznNTmTQR2Kg5Z'; // replace with "bob" account private key
    /* new accounts for testing can be created by unlocking a cleos wallet then calling: 
    * 1) cleos create key --to-console (copy this privateKey & publicKey)
    * 2) cleos wallet import 
    * 3) cleos create account bob publicKey
    * 4) cleos create account alice publicKey
    */

    const rpc = new eosjs_jsonrpc.JsonRpc('http://localhost:8888');
    const signatureProvider = new eosjs_jssig.JsSignatureProvider([privateKey]);
    const api = new eosjs_api.Api({ rpc, signatureProvider });
    let resultsLabel, transactionResponse, transactionSignatures;

    const waitOneSecond = () => new Promise(resolve => setTimeout(resolve, 1000))

    const transactWithConfig = async (e) => {
        if (e) {
            resultsLabel = e.target.nextSibling;
            resultsLabel.innerText = "Executing Test";
        }
        transactionResponse = await api.transact({
            actions: [{
                account: 'eosio.token',
                name: 'transfer',
                authorization: [{
                    actor: 'bob',
                    permission: 'active',
                }],
                data: {
                    from: 'bob',
                    to: 'alice',
                    quantity: '0.0001 SYS',
                    memo: '',
                },
            }]
        }, {
            blocksBehind: 3,
            expireSeconds: 30,
        });

        if (e && transactionResponse.transaction_id) {
            resultsLabel.innerText = "SUCCESS";
        }

        return transactionResponse;
    }

    const transactWithoutConfig = async (e) => {
        resultsLabel = e.target.nextSibling;
        resultsLabel.innerText = "Executing Test";

        transactionResponse = await transactWithConfig();
        const blockInfo = await rpc.get_block(transactionResponse.processed.block_num - 3);
        const currentDate = new Date();
        const timePlusTen = currentDate.getTime() + 10000;
        const timeInISOString = (new Date(timePlusTen)).toISOString();
        const expiration = timeInISOString.substr(0, timeInISOString.length - 1);

        transactionResponse = await api.transact({
            expiration,
            ref_block_num: blockInfo.block_num & 0xffff,
            ref_block_prefix: blockInfo.ref_block_prefix,
            actions: [{
                account: 'eosio.token',
                name: 'transfer',
                authorization: [{
                    actor: 'bob',
                    permission: 'active',
                }],
                data: {
                    from: 'bob',
                    to: 'alice',
                    quantity: '0.0001 SYS',
                    memo: '',
                },
            }]
        });

        if (transactionResponse.transaction_id) {
            resultsLabel.innerText = "SUCCESS";
        }

        return transactionResponse;
    };
        

    const transactWithoutBroadcast = async (e) => {
        resultsLabel = e.target.nextSibling;
        resultsLabel.innerText = "Executing Test";

        transactionSignatures = await api.transact({
            actions: [{
                account: 'eosio.token',
                name: 'transfer',
                authorization: [{
                    actor: 'bob',
                    permission: 'active',
                }],
                data: {
                    from: 'bob',
                    to: 'alice',
                    quantity: '0.0001 SYS',
                    memo: '',
                },
            }]
            }, {
                broadcast: false,
                blocksBehind: 3,
                expireSeconds: 30,
        });

        if(transactionSignatures.signatures && transactionSignatures.serializedTransaction) {
            resultsLabel.innerText = "SUCCESS";
        }
    };

    const broadcastResult = async (signaturesAndPackedTransaction) => await api.pushSignedTransaction(signaturesAndPackedTransaction);

    const transactShouldFail = async () => await api.transact({
        actions: [{
            account: 'eosio.token',
            name: 'transfer',
            authorization: [{
                actor: 'bob',
                permission: 'active',
            }],
            data: {
                from: 'bob',
                to: 'alice',
                quantity: '0.0001 SYS',
                memo: '',
            },
        }]
    });
    
    const rpcShouldFail = async () => await rpc.get_block(-1);

    const runAllTests = async () => {
        const buttons = document.getElementsByTagName('button');
        for (var i = 1; i < buttons.length; i++) {
            var button = buttons[i];
            button.click();
            await waitOneSecond();
        }
        return;
    }
</script>
